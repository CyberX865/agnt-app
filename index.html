<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>AGNT â€” AI Agent Economy on TON</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@2.0.6/dist/tonconnect-ui.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#050810;--bg2:#0a0f1a;--bg3:#0f1628;--card:#111c32;--card2:#162240;
  --bdr:#1a2744;--bdr2:#243356;
  --g:#00ffc8;--g2:#00d4a6;--gd:rgba(0,255,200,.06);--gg:rgba(0,255,200,.15);--gl:rgba(0,255,200,.25);
  --p:#b794f6;--pd:rgba(183,148,246,.06);
  --b:#63b3ed;--bd:rgba(99,179,237,.06);
  --o:#f6c851;--od:rgba(246,200,81,.06);
  --r:#fc5c65;--rd:rgba(252,92,101,.06);
  --t:#e8edf5;--t2:#8899b4;--t3:#4a5f82;--t4:#2d3f5e;
  --font:'Space Grotesk',sans-serif;--mono:'JetBrains Mono',monospace;
  --radius:14px;--radius-sm:10px;--radius-xs:7px;
}
html,body{background:var(--bg);color:var(--t);font-family:var(--font);height:100%;overflow:hidden;-webkit-font-smoothing:antialiased}

/* â•â•â• APP SHELL â•â•â• */
.app{height:100%;display:flex;flex-direction:column;position:relative}
.app::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 30% 20%,rgba(0,255,200,.03) 0%,transparent 50%),radial-gradient(ellipse at 70% 80%,rgba(183,148,246,.02) 0%,transparent 50%);pointer-events:none;z-index:0}

/* â•â•â• HEADER â•â•â• */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:rgba(10,15,26,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--bdr);z-index:20;position:relative}
.logo{display:flex;align-items:center;gap:8px}
.logo-mark{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--g),var(--g2));display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-weight:700;font-size:14px;color:#000;box-shadow:0 0 20px var(--gg),0 0 40px rgba(0,255,200,.08);position:relative}
.logo-mark::after{content:'';position:absolute;inset:-1px;border-radius:11px;background:linear-gradient(135deg,var(--g),var(--p));opacity:.3;z-index:-1;filter:blur(4px)}
.logo-name{font-weight:700;font-size:18px;letter-spacing:-.4px;background:linear-gradient(135deg,var(--t),var(--t2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-badge{font-family:var(--mono);font-size:8px;font-weight:600;color:var(--g);background:var(--gd);border:1px solid rgba(0,255,200,.12);padding:2px 6px;border-radius:4px;letter-spacing:.5px}
.hdr-r{display:flex;align-items:center;gap:8px}
.notif-btn{width:34px;height:34px;border-radius:var(--radius-sm);background:var(--bg3);border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;position:relative;transition:all .2s}
.notif-btn:active{transform:scale(.9)}
.notif-dot{position:absolute;top:6px;right:6px;width:6px;height:6px;border-radius:50%;background:var(--r);border:1.5px solid var(--bg3);animation:notifPulse 2s infinite}
@keyframes notifPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.8)}}
.wallet-btn{display:flex;align-items:center;gap:6px;background:var(--gd);border:1px solid rgba(0,255,200,.12);color:var(--g);padding:7px 12px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;font-family:var(--mono);transition:all .2s;letter-spacing:-.2px}
.wallet-btn:active{transform:scale(.95)}
.wallet-btn.off{background:var(--bg3);border-color:var(--bdr);color:var(--t2)}
.w-dot{width:5px;height:5px;border-radius:50%;background:var(--g);box-shadow:0 0 6px var(--g);animation:pulse 2s infinite}
.wallet-btn.off .w-dot{background:var(--t3);box-shadow:none;animation:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â•â•â• BALANCE BAR â•â•â• */
.bal-bar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg2);border-bottom:1px solid var(--bdr)}
.bal-info{}
.bal-amount{display:flex;align-items:baseline;gap:6px}
.bal-num{font-family:var(--mono);font-size:24px;font-weight:700;color:var(--g);text-shadow:0 0 20px rgba(0,255,200,.2)}
.bal-sym{font-size:14px;color:var(--t2);font-weight:500}
.bal-sub{font-size:10px;color:var(--t3);font-family:var(--mono);margin-top:2px}
.bal-actions{display:flex;gap:10px}
.bal-act{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;transition:transform .15s}
.bal-act:active{transform:scale(.88)}
.bal-act-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .2s}
.bal-act-label{font-size:8px;color:var(--t3);font-weight:600;text-transform:uppercase;letter-spacing:.3px}

/* â•â•â• CONTENT AREA â•â•â• */
.content{flex:1;overflow-y:auto;padding-bottom:76px;position:relative;z-index:1;scroll-behavior:smooth}
.content::-webkit-scrollbar{display:none}

/* â•â•â• SECTIONS â•â•â• */
.section-label{padding:8px 16px;font-size:10px;color:var(--t3);font-weight:700;text-transform:uppercase;letter-spacing:.8px;display:flex;align-items:center;justify-content:space-between}
.section-link{font-size:10px;color:var(--g);text-transform:none;letter-spacing:0;cursor:pointer;font-weight:600}

/* â•â•â• STATS GRID â•â•â• */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding:0 16px 12px}
.stat-card{background:var(--card);border-radius:var(--radius-sm);padding:12px;border:1px solid var(--bdr);position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--g),transparent);opacity:.3}
.stat-label{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.6px;font-weight:700}
.stat-value{font-family:var(--mono);font-size:16px;font-weight:700;margin-top:4px;transition:all .3s}
.stat-change{font-size:9px;margin-top:2px;font-weight:600}
.stat-change.up{color:var(--g)}

/* â•â•â• MINI CHART â•â•â• */
.chart-card{margin:0 16px 12px;background:var(--card);border-radius:var(--radius);padding:16px;border:1px solid var(--bdr);position:relative;overflow:hidden}
.chart-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,var(--g),var(--p),var(--b));opacity:.4}
.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.chart-price{font-family:var(--mono);font-size:20px;font-weight:700}
.chart-change{font-size:11px;color:var(--g);font-weight:600}
.chart-svg{width:100%;height:60px}

/* â•â•â• AGENT CARDS (HORIZONTAL SCROLL) â•â•â• */
.agent-scroll{display:flex;gap:10px;padding:0 16px 16px;overflow-x:auto;scrollbar-width:none;scroll-snap-type:x mandatory}
.agent-scroll::-webkit-scrollbar{display:none}
.agent-card{min-width:180px;background:var(--card);border-radius:var(--radius);padding:14px;border:1px solid var(--bdr);cursor:pointer;position:relative;overflow:hidden;scroll-snap-align:start;transition:all .2s}
.agent-card:active{transform:scale(.96);background:var(--card2)}
.agent-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent,var(--g)),var(--b));opacity:.7}
.agent-top{display:flex;align-items:center;gap:9px;margin-bottom:10px}
.agent-avatar{width:36px;height:36px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:17px;position:relative}
.agent-avatar::after{content:'';position:absolute;inset:0;border-radius:11px;border:1px solid rgba(255,255,255,.05)}
.agent-name{font-size:13px;font-weight:600;line-height:1.2}
.agent-cat{font-size:9px;color:var(--t3);font-weight:500}
.agent-stats{display:flex;justify-content:space-between;margin-top:6px}
.agent-stat-val{font-family:var(--mono);font-size:12px;font-weight:600}
.agent-stat-label{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:.3px;font-weight:600}

/* â•â•â• AGENT LIST â•â•â• */
.agent-list-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--bdr);cursor:pointer;transition:background .15s}
.agent-list-item:active{background:var(--bg3)}
.ali-icon{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;position:relative}
.ali-icon::after{content:'';position:absolute;bottom:2px;right:2px;width:8px;height:8px;border-radius:50%;background:var(--g);border:2px solid var(--bg);box-shadow:0 0 4px var(--g)}
.ali-info{flex:1;min-width:0}
.ali-name{font-size:13px;font-weight:600}
.ali-desc{font-size:11px;color:var(--t3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ali-right{text-align:right;flex-shrink:0}
.ali-price{font-family:var(--mono);font-size:12px;font-weight:700;color:var(--g)}
.ali-rating{font-size:9px;color:var(--t3);margin-top:2px}

/* â•â•â• TABS / PILLS â•â•â• */
.pill-tabs{display:flex;gap:5px;padding:10px 16px;overflow-x:auto;scrollbar-width:none}
.pill-tabs::-webkit-scrollbar{display:none}
.pill{padding:7px 14px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap;cursor:pointer;color:var(--t3);background:var(--bg3);border:1px solid transparent;transition:all .2s;letter-spacing:-.1px}
.pill.active{color:var(--g);background:var(--gd);border-color:rgba(0,255,200,.15);box-shadow:0 0 12px rgba(0,255,200,.08)}
.pill:active{transform:scale(.94)}

/* â•â•â• SEARCH â•â•â• */
.search-wrap{margin:0 16px 10px;position:relative}
.search-wrap input{width:100%;background:var(--bg3);border:1px solid var(--bdr);border-radius:var(--radius-sm);padding:10px 14px 10px 36px;color:var(--t);font-size:13px;outline:none;font-family:var(--font);transition:border-color .2s}
.search-wrap input:focus{border-color:var(--g);box-shadow:0 0 12px rgba(0,255,200,.06)}
.search-wrap input::placeholder{color:var(--t3)}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--t3)}

/* â•â•â• NAVIGATION â•â•â• */
.nav{display:flex;position:fixed;bottom:0;left:0;right:0;background:rgba(10,15,26,.95);backdrop-filter:blur(20px);border-top:1px solid var(--bdr);padding:4px 0 max(env(safe-area-inset-bottom),6px);z-index:50}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 0;cursor:pointer;color:var(--t3);transition:all .2s;position:relative}
.nav-item.active{color:var(--g)}
.nav-item.active::before{content:'';position:absolute;top:-1px;left:25%;right:25%;height:2px;background:var(--g);border-radius:0 0 2px 2px;box-shadow:0 0 8px var(--g)}
.nav-item:active{transform:scale(.85)}
.nav-icon{font-size:19px;transition:transform .15s}
.nav-label{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}

/* â•â•â• CHAT PANEL â•â•â• */
.chat-panel{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:100;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1)}
.chat-panel.open{transform:translateX(0)}
.chat-header{display:flex;align-items:center;gap:12px;padding:10px 16px;background:var(--bg2);border-bottom:1px solid var(--bdr)}
.chat-back{font-size:20px;cursor:pointer;padding:4px;color:var(--t2);transition:color .15s}
.chat-back:active{color:var(--g)}
.chat-agent-info{flex:1}
.chat-agent-name{font-size:15px;font-weight:600}
.chat-agent-status{font-size:10px;color:var(--g);display:flex;align-items:center;gap:4px}
.chat-agent-status::before{content:'';width:5px;height:5px;border-radius:50%;background:var(--g);box-shadow:0 0 6px var(--g)}
.chat-cost{font-family:var(--mono);font-size:10px;color:var(--t3);background:var(--bg3);padding:4px 8px;border-radius:6px;border:1px solid var(--bdr)}
.chat-messages{flex:1;overflow-y:auto;padding:16px 16px 80px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
.chat-messages::-webkit-scrollbar{display:none}
.msg{max-width:82%;padding:10px 14px;border-radius:16px;font-size:13px;line-height:1.5;animation:msgIn .3s cubic-bezier(.4,0,.2,1)}
@keyframes msgIn{from{opacity:0;transform:translateY(8px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.msg.user{background:linear-gradient(135deg,var(--g),var(--g2));color:#000;align-self:flex-end;border-bottom-right-radius:4px;font-weight:500}
.msg.agent{background:var(--card);border:1px solid var(--bdr);align-self:flex-start;border-bottom-left-radius:4px}
.msg.system{align-self:center;font-size:10px;color:var(--t3);background:none;padding:4px 0}
.chat-input-area{display:flex;gap:8px;padding:8px 16px;background:var(--bg2);border-top:1px solid var(--bdr)}
.chat-input{flex:1;background:var(--bg3);border:1px solid var(--bdr);border-radius:20px;padding:10px 16px;color:var(--t);font-size:13px;outline:none;font-family:var(--font);transition:border-color .2s}
.chat-input:focus{border-color:var(--g)}
.chat-input::placeholder{color:var(--t3)}
.chat-send{width:38px;height:38px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--g),var(--g2));color:#000;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;font-weight:700}
.chat-send:active{transform:scale(.88)}
.typing{display:flex;gap:4px;padding:4px 8px;align-items:center}
.typing span{width:6px;height:6px;border-radius:50%;background:var(--t3);animation:typeDot 1.4s infinite}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes typeDot{0%,60%,100%{opacity:.3;transform:translateY(0)}30%{opacity:1;transform:translateY(-4px)}}

/* â•â•â• PAGES â•â•â• */
.page{display:none;opacity:0}.page.active{display:block;animation:pageIn .25s ease forwards}
@keyframes pageIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* â•â•â• EARN CARDS â•â•â• */
.earn-card{margin:6px 16px;background:var(--card);border-radius:var(--radius);padding:14px;border:1px solid var(--bdr);display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .2s}
.earn-card:active{background:var(--card2);transform:scale(.98)}
.earn-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.earn-info{flex:1}
.earn-title{font-size:13px;font-weight:600}
.earn-desc{font-size:11px;color:var(--t3);margin-top:1px}
.earn-reward{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--g);white-space:nowrap}
.earn-card.done{opacity:.5}
.earn-card.done .earn-title,.earn-card.done .earn-reward{color:var(--t3);text-decoration:line-through}

/* â•â•â• PROGRESS BAR â•â•â• */
.progress-bar{height:4px;background:var(--bg3);border-radius:2px;margin:8px 16px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--g),var(--p));border-radius:2px;transition:width .6s cubic-bezier(.4,0,.2,1)}

/* â•â•â• CONTRACT INFO â•â•â• */
.info-card{margin:0 16px 10px;background:var(--card);border-radius:var(--radius);padding:0;border:1px solid var(--bdr);overflow:hidden}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--bdr)}
.info-row:last-child{border:none}
.info-label{font-size:11px;color:var(--t3)}
.info-value{font-size:11px;font-family:var(--mono);color:var(--t2)}
.info-value.link{color:var(--g);cursor:pointer}

/* â•â•â• MODAL / OVERLAY â•â•â• */
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);z-index:150;display:none;align-items:flex-end}
.overlay.open{display:flex}
.modal{background:var(--bg2);border-radius:20px 20px 0 0;width:100%;max-height:85vh;overflow-y:auto;padding:20px;border-top:1px solid var(--bdr);animation:modalUp .3s cubic-bezier(.4,0,.2,1)}
@keyframes modalUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--bdr2);border-radius:2px;margin:0 auto 16px}
.modal h3{font-size:17px;font-weight:700;margin-bottom:4px}
.modal p{font-size:12px;color:var(--t2);margin-bottom:16px}
.form-group{margin-bottom:14px}
.form-label{font-size:11px;color:var(--t3);font-weight:600;margin-bottom:4px;display:block}
.form-input{width:100%;background:var(--bg3);border:1px solid var(--bdr);border-radius:var(--radius-sm);padding:11px 14px;color:var(--t);font-size:13px;outline:none;font-family:var(--font);transition:border-color .2s}
.form-input:focus{border-color:var(--g)}
.form-input::placeholder{color:var(--t3)}
.form-select{width:100%;background:var(--bg3);border:1px solid var(--bdr);border-radius:var(--radius-sm);padding:11px 14px;color:var(--t);font-size:13px;outline:none;font-family:var(--font);appearance:none}

/* â•â•â• BUTTONS â•â•â• */
.btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .15s;letter-spacing:-.2px}
.btn:active{transform:scale(.98)}
.btn-primary{background:linear-gradient(135deg,var(--g),var(--g2));color:#000;box-shadow:0 4px 16px rgba(0,255,200,.2)}
.btn-secondary{background:var(--bg3);border:1px solid var(--bdr);color:var(--t)}
.btn-danger{background:var(--rd);border:1px solid rgba(252,92,101,.2);color:var(--r)}
.btn-hint{font-size:11px;color:var(--t3);text-align:center;margin-top:6px}
.btn-hint span{color:var(--g);font-family:var(--mono)}
.modal-close{display:block;text-align:center;font-size:12px;color:var(--t3);margin-top:12px;cursor:pointer;font-weight:500}

/* â•â•â• TOAST â•â•â• */
.toast{position:fixed;top:56px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--card);border:1px solid var(--g);color:var(--g);padding:10px 20px;border-radius:12px;font-size:12px;font-weight:600;z-index:200;transition:transform .3s cubic-bezier(.4,0,.2,1);pointer-events:none;box-shadow:0 8px 24px rgba(0,255,200,.12);white-space:nowrap;backdrop-filter:blur(12px)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.error{border-color:var(--r);color:var(--r);box-shadow:0 8px 24px rgba(252,92,101,.12)}

/* â•â•â• LOADING SHIMMER â•â•â• */
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
.skeleton{background:linear-gradient(90deg,var(--bg3) 25%,var(--bdr) 50%,var(--bg3) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}

/* â•â•â• ANIMATIONS â•â•â• */
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
.anim-fadeup{animation:fadeUp .4s ease both}
.anim-fadeup-1{animation:fadeUp .4s ease .05s both}
.anim-fadeup-2{animation:fadeUp .4s ease .1s both}
.anim-fadeup-3{animation:fadeUp .4s ease .15s both}
.anim-fadeup-4{animation:fadeUp .4s ease .2s both}
.anim-scalein{animation:scaleIn .3s ease both}

/* â•â•â• PROFILE â•â•â• */
.profile-header{padding:20px 16px;text-align:center}
.profile-avatar{width:60px;height:60px;border-radius:18px;background:linear-gradient(135deg,var(--g),var(--p));margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 8px 24px rgba(0,255,200,.15);position:relative}
.profile-avatar::after{content:'';position:absolute;inset:-2px;border-radius:20px;background:linear-gradient(135deg,var(--g),var(--p));opacity:.3;z-index:-1;filter:blur(8px)}
.profile-name{font-size:17px;font-weight:700}
.profile-addr{font-size:11px;color:var(--t3);font-family:var(--mono);margin-top:3px}
.profile-actions{display:flex;gap:8px;justify-content:center;margin-top:12px}
.profile-btn{padding:8px 18px;font-size:12px;font-weight:600;border-radius:20px;background:var(--bg3);border:1px solid var(--bdr);color:var(--t);cursor:pointer;font-family:var(--font);transition:all .15s}
.profile-btn:active{transform:scale(.95);background:var(--card2)}

/* â•â•â• CHAT PAGE (Recent Chats) â•â•â• */
.empty-state{padding:50px 30px;text-align:center}
.empty-icon{font-size:48px;margin-bottom:12px}
.empty-title{font-size:17px;font-weight:600;margin-bottom:6px}
.empty-desc{font-size:13px;color:var(--t3)}

/* â•â•â• v3 IMPROVEMENTS â•â•â• */
.agent-card:hover::before,.agent-card:active::before{opacity:1}
.agent-list-item{transition:background .15s,transform .1s}
.agent-list-item:active{transform:scale(.98)}
.welcome-banner{transition:all .2s}
.msg.agent{position:relative}
.msg.agent::before{content:'';position:absolute;top:0;left:0;bottom:0;width:2px;background:linear-gradient(var(--g),var(--p));border-radius:1px;opacity:.5}
.chat-send:hover{box-shadow:0 0 16px rgba(0,255,200,.3)}
.btn-primary:hover{box-shadow:0 4px 20px rgba(0,255,200,.3)}
.nav-item{transition:all .15s}
.stat-card{transition:transform .15s}
.stat-card:active{transform:scale(.95)}
.earn-card{position:relative;overflow:hidden}
.earn-card:not(.done)::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--g),transparent);opacity:.3}

/* â•â•â• v3.5 POLISH â•â•â• */
@media(hover:hover){
  .agent-card:hover{border-color:var(--bdr2);background:var(--card2)}
  .agent-list-item:hover{background:rgba(15,22,40,.5)}
  .pill:hover{color:var(--t);background:var(--card)}
  .earn-card:hover{border-color:var(--bdr2)}
  .nav-item:hover{color:var(--t)}
}
.msg.user{box-shadow:0 2px 8px rgba(0,255,200,.15)}
.msg.system{font-family:var(--mono);letter-spacing:-.2px}
.form-input:focus,.chat-input:focus{box-shadow:0 0 0 2px rgba(0,255,200,.08)}
.btn-primary{position:relative;overflow:hidden}
.btn-primary::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 60%);opacity:0;transition:opacity .3s}
.btn-primary:active::after{opacity:1}
</style>
</head>
<body>
<div class="app">

<!-- HEADER -->
<div class="hdr">
  <div class="logo">
    <div class="logo-mark">A</div>
    <span class="logo-name">AGNT</span>
    <span class="logo-badge">TON</span><span class="logo-badge" style="color:var(--p);background:var(--pd);border-color:rgba(183,148,246,.12);margin-left:2px">LIVE</span>
  </div>
  <div class="hdr-r">
    <div class="notif-btn" onclick="openModal('notifs')">ğŸ””<div class="notif-dot" id="nDot"></div></div>
    <div class="wallet-btn off" id="walletBtn" onclick="handleWallet()">
      <span class="w-dot"></span>
      <span id="walletTxt">Connect</span>
    </div>
  </div>
</div>

<!-- BALANCE BAR -->
<div class="bal-bar">
  <div class="bal-info">
    <div class="bal-amount">
      <span class="bal-num" id="balNum">0</span>
      <span class="bal-sym">AGNT</span>
    </div>
    <div class="bal-sub" id="balSub">Connect wallet to view</div>
  </div>
  <div class="bal-actions">
    <div class="bal-act" onclick="openModal('send')"><div class="bal-act-icon" style="background:var(--gd);color:var(--g)">â†‘</div><span class="bal-act-label">Send</span></div>
    <div class="bal-act" onclick="openModal('receive')"><div class="bal-act-icon" style="background:var(--pd);color:var(--p)">â†“</div><span class="bal-act-label">Receive</span></div>
    <div class="bal-act" onclick="openModal('swap')"><div class="bal-act-icon" style="background:var(--bd);color:var(--b)">â‡„</div><span class="bal-act-label">Swap</span></div>
    <div class="bal-act" onclick="openModal('history')"><div class="bal-act-icon" style="background:var(--od);color:var(--o)">ğŸ“‹</div><span class="bal-act-label">History</span></div>
  </div>
</div>

<!-- CONTENT AREA -->
<div class="content">

<!-- PAGE: HOME -->
<div class="page active" id="pageHome">
  <div id="homeContent"></div>
</div>

<!-- PAGE: AGENTS -->
<div class="page" id="pageAgents">
  <div class="search-wrap">
    <span class="search-icon">ğŸ”</span>
    <input placeholder="Search agents..." oninput="filterAgents(this.value)">
  </div>
  <div class="pill-tabs" id="agentTabs"></div>
  <div id="agentList"></div>
  <div style="padding:16px">
    <button class="btn btn-primary" onclick="openModal('deploy')">+ Deploy New Agent â€” 0.5 TON</button>
  </div>
</div>

<!-- PAGE: CHAT -->
<div class="page" id="pageChat">
  <div id="chatPageContent">
    <div style="padding:16px 16px 8px"><h3 style="font-size:17px;font-weight:700">Chats</h3><p style="font-size:12px;color:var(--t2);margin-top:2px">Your AI conversations</p></div>
    <div id="recentChats" style="text-align:left"></div>
    <div id="chatEmptyMsg" style="padding:30px;text-align:center">
      <div style="font-size:48px;margin-bottom:8px">ğŸ’¬</div>
      <div style="font-size:13px;color:var(--t3)">No chats yet</div>
      <button class="btn btn-primary" style="max-width:200px;margin:14px auto 0" onclick="switchTab(1)">Browse Agents</button>
    </div>
  </div>
</div>

<!-- PAGE: EARN -->
<div class="page" id="pageEarn">
  <div style="padding:16px 16px 4px">
    <h3 style="font-size:17px;font-weight:700">Earn AGNT</h3>
    <p style="font-size:12px;color:var(--t2);margin-top:3px">Complete tasks to earn tokens</p>
    <div style="margin-top:10px;display:flex;gap:6px">
      <div style="flex:1;text-align:center;padding:10px 6px;background:var(--card);border:1px solid var(--bdr);border-radius:10px">
        <div style="font-family:var(--mono);font-size:16px;font-weight:700;color:var(--g)" id="earnTotalBig">0</div>
        <div style="font-size:8px;color:var(--t3);text-transform:uppercase;margin-top:2px">Earned</div>
      </div>
      <div style="flex:1;text-align:center;padding:10px 6px;background:var(--card);border:1px solid var(--bdr);border-radius:10px">
        <div style="font-family:var(--mono);font-size:16px;font-weight:700;color:var(--o)" id="earnRemain">0</div>
        <div style="font-size:8px;color:var(--t3);text-transform:uppercase;margin-top:2px">Remaining</div>
      </div>
      <div style="flex:1;text-align:center;padding:10px 6px;background:var(--card);border:1px solid var(--bdr);border-radius:10px">
        <div style="font-family:var(--mono);font-size:16px;font-weight:700;color:var(--p)" id="earnMsgs">0</div>
        <div style="font-size:8px;color:var(--t3);text-transform:uppercase;margin-top:2px">Messages</div>
      </div>
    </div>
  </div>
  <div style="padding:4px 16px;display:flex;justify-content:space-between;font-size:11px;color:var(--t3)">
    <span id="earnProgress"></span>
    <span id="earnTotal" style="color:var(--g)"></span>
  </div>
  <div class="progress-bar"><div class="progress-fill" id="earnBar"></div></div>
  <div id="earnList"></div>
</div>

<!-- PAGE: PROFILE -->
<div class="page" id="pageProfile">
  <div class="profile-header">
    <div class="profile-avatar">ğŸ‘¤</div>
    <div class="profile-name" id="profileName">â€”</div>
    <div class="profile-addr" id="profileAddr">Connect wallet</div>
    <div class="profile-actions">
      <button class="profile-btn" onclick="openModal('editProfile')">Edit Profile</button>
      <button class="profile-btn" onclick="openModal('settings')">Settings</button>
      <button class="profile-btn" onclick="openModal('referral')" style="color:var(--g);border-color:rgba(0,255,200,.2)">Share</button>
    </div>
  </div>
  <div class="stats-grid" id="profileStats"></div>
  <div class="section-label"><span>Contract Info</span></div>
  <div class="info-card">
    <div class="info-row"><span class="info-label">Token</span><span class="info-value">AGNT</span></div>
    <div class="info-row"><span class="info-label">Decimals</span><span class="info-value">9</span></div>
    <div class="info-row"><span class="info-label">Total Supply</span><span class="info-value">100,000,000</span></div>
    <div class="info-row"><span class="info-label">Contract</span><span class="info-value link" onclick="window.open('https://tonviewer.com/'+CONTRACT)">EQDLly...T-fc</span></div>
    <div class="info-row"><span class="info-label">Network</span><span class="info-value">TON Mainnet</span></div>
  </div>
  <div class="section-label"><span>My Agents</span></div>
  <div id="profileAgents"></div>
</div>

</div><!-- /content -->

<!-- NAVIGATION -->
<div class="nav">
  <div class="nav-item active" onclick="switchTab(0)"><span class="nav-icon">ğŸ </span><span class="nav-label">Home</span></div>
  <div class="nav-item" onclick="switchTab(1)"><span class="nav-icon">ğŸ¤–</span><span class="nav-label">Agents</span></div>
  <div class="nav-item" onclick="switchTab(2)"><span class="nav-icon">ğŸ’¬</span><span class="nav-label">Chat</span></div>
  <div class="nav-item" onclick="switchTab(3)"><span class="nav-icon">ğŸ’°</span><span class="nav-label">Earn</span></div>
  <div class="nav-item" onclick="switchTab(4)"><span class="nav-icon">ğŸ‘¤</span><span class="nav-label">Profile</span></div>
</div>

<!-- CHAT PANEL (fullscreen overlay) -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <span class="chat-back" onclick="closeChat()">â†</span>
    <div class="chat-agent-info">
      <div class="chat-agent-name" id="chatAgentName"></div>
      <div class="chat-agent-status">Online â€” AI Powered</div>
    </div>
    <div class="chat-cost" id="chatCost"></div>
    <div style="font-size:16px;cursor:pointer;padding:4px" onclick="if(currentAgent&&confirm('Clear chat history?')){chatHistories[currentAgent.id]=[{type:'system',text:'Chat cleared'},{type:'agent',text:currentAgent.icon+' How can I help?'}];renderMessages();saveState()}">ğŸ—‘ï¸</div>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input-area">
    <input class="chat-input" id="chatInput" placeholder="Ask anything..." onkeydown="if(event.key==='Enter')sendMessage()">
    <button class="chat-send" onclick="sendMessage()">â†‘</button>
  </div>
</div>

<!-- OVERLAY/MODAL -->
<div class="overlay" id="overlay" onclick="event.target===this&&closeModal()">
  <div class="modal">
    <div class="modal-handle"></div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

</div><!-- /app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AGNT â€” AI Agent Economy on TON
//  Production Build v3.5
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â• CONFIG â•â•â•
const CONTRACT = 'EQDLlyWDdDr9JQf-NIXsfJUGBINJ0eKNIYf1eKuWNN9aT-fc';
const OWNER_WALLET = 'UQBvwYth8pyn14UCRi51rL6JDc6z3TbQfIh0i_1sNKLkjxu2';
const DECIMALS = 9;
const PROXY_URL = 'https://cyberx865--253f5f060e2611f1b12642dde27851f2.web.val.run';
// API key secured on backend proxy
// AI model handled by proxy (Claude Haiku)

// â•â•â• AGENTS DATA â•â•â•
const AGENTS = [
  {id:1, name:"TradingBot Pro", cat:"Trading", icon:"ğŸ“ˆ", color:"#00ffc8", price:0.05, queries:0, rating:4.8, desc:"Advanced TON/USDT technical analysis with entry/exit signals"},
  {id:2, name:"DeFi Wizard", cat:"DeFi", icon:"ğŸ§™", color:"#b794f6", price:0.03, queries:0, rating:4.6, desc:"Yield farming strategies and liquidity pool analysis"},
  {id:3, name:"NFT Scout", cat:"NFT", icon:"ğŸ¨", color:"#f6c851", price:0.05, queries:0, rating:4.7, desc:"Discover undervalued NFT collections before they pump"},
  {id:4, name:"Alpha Hunter", cat:"Trading", icon:"ğŸ¯", color:"#fc5c65", price:0.1, queries:0, rating:4.9, desc:"Real-time whale tracking and alpha leak detection"},
  {id:5, name:"Social Pulse", cat:"Social", icon:"ğŸ“¡", color:"#63b3ed", price:0.02, queries:0, rating:4.5, desc:"Telegram & Twitter sentiment for TON ecosystem"},
  {id:6, name:"Gas Oracle", cat:"Data", icon:"â›½", color:"#00ffc8", price:0.01, queries:0, rating:4.3, desc:"Optimal gas timing and network congestion predictions"},
  {id:7, name:"Memecoin Radar", cat:"Trading", icon:"ğŸ¸", color:"#a3e635", price:0.05, queries:0, rating:4.4, desc:"Early detection of trending memecoins on TON DEXes"},
  {id:8, name:"Portfolio AI", cat:"DeFi", icon:"ğŸ’¼", color:"#b794f6", price:0.03, queries:0, rating:4.7, desc:"Personalized portfolio rebalancing and risk assessment"}
];

const TASKS = [
  {icon:"ğŸ‘‹", title:"Join Community", desc:"Follow on Telegram & Twitter", reward:100, done:false},
  {icon:"ğŸ”—", title:"Connect Wallet", desc:"Link your TON wallet", reward:200, done:false},
  {icon:"ğŸ’¬", title:"First AI Query", desc:"Chat with any agent", reward:50, done:false},
  {icon:"ğŸ¤–", title:"Deploy an Agent", desc:"Create your own AI agent", reward:500, done:false},
  {icon:"ğŸ“£", title:"Invite 3 Friends", desc:"Share your referral link", reward:300, done:false},
  {icon:"ğŸ”¥", title:"100 Queries", desc:"Use agents 100 times", reward:1000, done:false},
  {icon:"ğŸ’", title:"Diamond Hands", desc:"Hold 10K AGNT for 7 days", reward:2000, done:false}
];

const AGENT_PROMPTS = {
  "TradingBot Pro":"You are TradingBot Pro on the AGNT platform (TON blockchain). Give concise TON/USDT technical analysis with specific entry/exit signals, support/resistance levels, RSI & MACD readings. Always include risk warnings. Use emojis. Max 150 words.",
  "DeFi Wizard":"You are DeFi Wizard on AGNT (TON blockchain). Analyze yield farms, liquidity pools, and impermanent loss risks. Give specific strategies for STON.fi and DeDust. Include APR/APY numbers. Use emojis. Max 150 words.",
  "NFT Scout":"You are NFT Scout on AGNT (TON blockchain). Find undervalued collections, analyze floor prices, spot rare traits. Cover Getgems, TON Diamonds, TON DNS. Use emojis. Max 150 words.",
  "Alpha Hunter":"You are Alpha Hunter on AGNT (TON blockchain). Track large wallet movements, upcoming launches, insider alpha signals. Be dramatic but accurate. Use emojis. Max 150 words.",
  "Social Pulse":"You are Social Pulse on AGNT (TON blockchain). Analyze Telegram group sentiment, Twitter trends, community mood. Give scores 1-100. Use emojis. Max 150 words.",
  "Gas Oracle":"You are Gas Oracle on AGNT (TON blockchain). Report current gas costs, optimal transaction timing, network congestion status. Be technical. Use emojis. Max 150 words.",
  "Memecoin Radar":"You are Memecoin Radar on AGNT (TON blockchain). Detect new memecoin launches on TON DEXes, track trending tokens, warn about rugs. Use emojis. Max 150 words.",
  "Portfolio AI":"You are Portfolio AI on AGNT (TON blockchain). Analyze crypto holdings, suggest rebalancing, calculate risk scores 1-10. Be professional. Use emojis. Max 150 words."
};

// Fallback responses for when AI is unavailable
const FALLBACK_RESPONSES = {
  "TradingBot Pro":["ğŸ“Š <b>TON/USDT Quick Analysis:</b><br><br>Current trend: Bullish above $6.20 support<br>RSI: 58 â€” neutral bullish zone<br>Key resistance: $6.80 and $7.15<br><br>âœ… Strategy: Accumulate $6.20-6.40 range<br>ğŸ¯ Target: $7.00-7.20<br>â›” Stop loss: $5.95<br><br>âš ï¸ DYOR â€” Not financial advice","ğŸ‹ <b>Whale Alert Update:</b><br><br>Major accumulation detected â€” 2.4M TON bought on OKX in the last 4 hours. Smart money moving in.<br><br>ğŸ”¥ This usually precedes a 5-8% pump within 24-48h<br>ğŸ“ˆ Volume spike confirms buying pressure<br><br>Watch for breakout above $6.80!"],
  "DeFi Wizard":["ğŸ§™ <b>Top TON Yield Farms Right Now:</b><br><br>1. ğŸ¥‡ STON.fi TON/USDT â€” 42% APR<br>2. ğŸ¥ˆ DeDust TON/SCALE â€” 67% APR (higher risk)<br>3. ğŸ¥‰ Bemo stTON staking â€” 5.8% APR (safest)<br><br>ğŸ’¡ My pick: Split 60/40 between STON.fi and Bemo for balanced risk/reward<br><br>âš ï¸ Always check IL risk before LPing"],
  "NFT Scout":["ğŸ¨ <b>Hot TON NFT Collections:</b><br><br>1. ğŸ’ TON Diamonds â€” Floor up 45% this week<br>2. ğŸ­ Getgems Punks â€” New utility announcement incoming<br>3. ğŸŒ TON DNS â€” 3-letter domains trending hard<br><br>ğŸ”¥ Best value pick: TON DNS 4-letter domains, still underpriced at 2-5 TON"],
  "Alpha Hunter":["ğŸ¯ <b>Fresh Alpha Drop:</b><br><br>ğŸ”’ New DEX launching next week â€” team includes ex-Uniswap devs<br>ğŸ’° 5% airdrop confirmed for early liquidity providers<br>ğŸ‹ Three whale wallets already positioning<br><br>âš¡ Action: Watch announcement channel, be ready to LP within first hour"],
  "Social Pulse":["ğŸ“¡ <b>TON Ecosystem Sentiment:</b><br><br>ğŸ“Š Overall Score: 78/100 (Bullish)<br><br>ğŸ”µ Telegram: Very bullish (82/100)<br>ğŸ¦ Twitter: Bullish (74/100)<br>ğŸ“° News: Neutral-positive (71/100)<br><br>#TONecosystem trending in crypto circles<br>Community growth: +12% this week"],
  "Gas Oracle":["â›½ <b>TON Network Status:</b><br><br>ğŸ’° Current gas: ~0.005 TON (Low!)<br>ğŸ“Š Network load: 34% capacity<br>â° Best time: 02:00-06:00 UTC<br>ğŸš¦ Status: All green â€” great time for transactions<br><br>ğŸ’¡ Tip: Batch your transactions now while gas is cheap"],
  "Memecoin Radar":["ğŸ¸ <b>Trending Memecoins on TON:</b><br><br>ğŸ”¥ $TONDOG â€” +340% (24h) â€” High volume<br>ğŸš€ $JETTON â€” +89% (24h) â€” New listings<br>âš ï¸ $TONCAT â€” -45% â€” Possible rug, avoid<br><br>ğŸ’¡ Strategy: Take profits at 2-3x, never ape full portfolio<br>ğŸ›¡ï¸ Always check: locked liquidity, renounced contract, team doxx"],
  "Portfolio AI":["ğŸ’¼ <b>Portfolio Health Check:</b><br><br>ğŸ“Š Diversification Score: 7.4/10<br>ğŸ¯ Risk Level: Medium<br><br>Suggestions:<br>â€¢ Move 15% from memecoins â†’ stablecoins<br>â€¢ Increase TON core position by 10%<br>â€¢ Add DeFi exposure via STON.fi LP<br><br>Expected improvement: Risk score 7.4 â†’ 8.2<br><br>âš ï¸ Review weekly, rebalance monthly"]
};

// â•â•â• STATE â•â•â•
let balance = 0;
let currentAgent = null;
let chatHistories = {};
let transactions = [];
let agentFilter = 'All';
let agentSearch = '';
let tonUI = null;
let wallet = null;
let userAddress = '';
let totalMsgCount = 0;

// Referral system
function getReferralLink() {
  const base = 'https://t.me/AGNT_bot/app';
  if (userAddress) return base + '?startapp=ref_' + userAddress.slice(0,8);
  return base;
}

// â•â•â• TONCONNECT â•â•â•
async function initTonConnect() {
  try {
    tonUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://raw.githubusercontent.com/CyberX865/agnt-app/main/tonconnect-manifest.json',
      buttonRootId: null
    });
    tonUI.onStatusChange(w => {
      wallet = w;
      if (w) {
        userAddress = w.account.address;
        const short = userAddress.slice(0, 4) + '...' + userAddress.slice(-4);
        document.getElementById('walletTxt').textContent = short;
        document.getElementById('walletBtn').classList.remove('off');
        document.getElementById('profileAddr').textContent = short;
        document.getElementById('balSub').textContent = 'Loading balance...';
        toast('ğŸ”— Wallet connected!'); haptic('success');
        fetchBalance();
        // Auto-complete connect wallet task
        if (!TASKS[1].done) { TASKS[1].done = true; }
        if (window.Telegram && Telegram.WebApp) {
          const u = Telegram.WebApp.initDataUnsafe?.user;
          if (u) document.getElementById('profileName').textContent = u.first_name || 'User';
        }
      } else {
        document.getElementById('walletTxt').textContent = 'Connect';
        document.getElementById('walletBtn').classList.add('off');
        document.getElementById('balNum').textContent = '0';
        document.getElementById('balSub').textContent = 'Connect wallet to view';
        document.getElementById('profileName').textContent = 'â€”';
        document.getElementById('profileAddr').textContent = 'Connect wallet';
        userAddress = '';
      }
      renderAll();
    });
  } catch (e) { console.log('TonConnect error:', e); }
}

function handleWallet() {
  if (wallet) { openModal('wallet'); return; }
  if (tonUI) tonUI.openModal();
  else toast('TonConnect loading...', true);
}

let tonBalance = 0;

async function fetchBalance() {
  // Fetch TON balance
  try {
    const tr = await fetch('https://tonapi.io/v2/accounts/' + userAddress);
    const td = await tr.json();
    if (td.balance) {
      tonBalance = parseInt(td.balance) / 1e9;
    }
  } catch(e) {}
  
  // Fetch AGNT jetton balance
  try {
    const r = await fetch('https://tonapi.io/v2/accounts/' + userAddress + '/jettons');
    const d = await r.json();
    const j = d.balances?.find(b => b.jetton?.address?.includes('LlyWDdDr9'));
    if (j) {
      balance = parseInt(j.balance || '0') / Math.pow(10, DECIMALS);
    }
  } catch (e) {}
  
  updateBalance();
}

function updateBalance() {
  document.getElementById('balNum').textContent = Math.floor(balance).toLocaleString();
  document.getElementById('balSub').textContent = tonBalance > 0 ? tonBalance.toFixed(2) + ' TON available' : 'Mainnet Â· AGNT Token';
}

// â•â•â• TELEGRAM â•â•â•
function initTelegram() {
  if (window.Telegram && Telegram.WebApp) {
    const tg = Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#050810');
    tg.setBackgroundColor('#050810');
    const u = tg.initDataUnsafe?.user;
    if (u) document.getElementById('profileName').textContent = u.first_name || 'User';
  }
}

// â•â•â• PAYMENT â•â•â•
async function sendTONPayment(tonAmount) {
  if (!tonUI || !wallet) return false;
  try {
    const nanoTON = String(Math.floor(tonAmount * 1000000000));
    const tx = {
      validUntil: Math.floor(Date.now() / 1000) + 300,
      messages: [{ address: OWNER_WALLET, amount: nanoTON }]
    };
    await tonUI.sendTransaction(tx);
    return true;
  } catch (e) {
    if (e && e.message && e.message.includes('cancel')) toast('Payment cancelled', true); haptic('error');
    else toast('Payment failed â€” try again', true); haptic('error');
    return false;
  }
}

// â•â•â• AI ENGINE â•â•â•
async function callAI(agentName, userMsg) {
  const sysPrompt = AGENT_PROMPTS[agentName] || "You are a helpful AI agent on AGNT (TON blockchain). Be concise. Use emojis.";
  
  // Try val.town proxy (Claude Haiku backend)
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 20000);
    const r = await fetch(PROXY_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({system: sysPrompt, message: userMsg}),
      signal: controller.signal
    });
    clearTimeout(timeout);
    if (r.ok) {
      const d = await r.json();
      if (d.choices && d.choices[0] && d.choices[0].message) {
        return d.choices[0].message.content;
      }
    }
  } catch(e) { /* timeout or network error */ }

  // Fallback to cached response
  return getFallback(agentName);
}

function getSuggestions(agentName) {
  const s = {
    "TradingBot Pro": ["TON price analysis", "Entry signals today", "Support levels?"],
    "DeFi Wizard": ["Best yields now?", "STON.fi vs DeDust", "Staking options"],
    "NFT Scout": ["Hot collections", "Floor price check", "Rare trait finder"],
    "Alpha Hunter": ["Whale movements", "Upcoming launches", "Smart money flow"],
    "Social Pulse": ["TON sentiment?", "Trending topics", "Community mood"],
    "Gas Oracle": ["Gas prices now", "Best time to TX", "Network status"],
    "Memecoin Radar": ["New launches today", "Trending tokens", "Rug check"],
    "Portfolio AI": ["Risk assessment", "Rebalance advice", "Diversification score"]
  };
  return s[agentName] || ["What can you do?", "Give me analysis", "Latest update"];
}

function getFallback(agentName) {
  const fb = FALLBACK_RESPONSES[agentName];
  if (fb && fb.length) return fb[Math.floor(Math.random() * fb.length)];
  return "ğŸ¤– I'm processing your query. Live AI is temporarily busy â€” please try again shortly.";
}

// â•â•â• NAVIGATION â•â•â•
const PAGES = ['pageHome', 'pageAgents', 'pageChat', 'pageEarn', 'pageProfile'];
function switchTab(idx) {
  document.querySelectorAll('.nav-item').forEach((n, j) => n.classList.toggle('active', j === idx));
  PAGES.forEach((p, j) => document.getElementById(p).classList.toggle('active', j === idx));
  document.querySelector('.content').scrollTop = 0;
  renderAll();
}

// â•â•â• RENDERING â•â•â•
function renderAll() { renderHome(); renderAgentList(); renderRecentChats(); renderEarn(); renderProfile(); }

function renderHome() {
  const totalQueries = AGENTS.reduce((s,a) => s + a.queries, 0);
  const totalSpent = transactions.reduce((s,t) => s + Math.abs(t.amount), 0);
  const topAgents = AGENTS.slice(0, 5);
  const html = `
    <div class="welcome-banner anim-fadeup" style="margin:12px 16px;background:linear-gradient(135deg,rgba(0,255,200,.08),rgba(183,148,246,.06));border:1px solid rgba(0,255,200,.12);border-radius:16px;padding:18px;position:relative;overflow:hidden">
      <div style="position:absolute;top:-20px;right:-20px;font-size:80px;opacity:.06">ğŸ¤–</div>
      <div style="font-size:15px;font-weight:700;margin-bottom:4px">Welcome to AGNT</div>
      <div style="font-size:12px;color:var(--t2);line-height:1.5">The AI Agent Economy on TON. Pay per query with TON, get instant AI-powered insights from specialized crypto agents.</div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <div style="font-size:10px;color:var(--g);background:var(--gd);padding:4px 10px;border-radius:12px;border:1px solid rgba(0,255,200,.1)">ğŸ§  Claude AI</div>
        <div style="font-size:10px;color:var(--p);background:var(--pd);padding:4px 10px;border-radius:12px;border:1px solid rgba(183,148,246,.1)">ğŸ’ TON Chain</div>
        <div style="font-size:10px;color:var(--b);background:var(--bd);padding:4px 10px;border-radius:12px;border:1px solid rgba(99,179,237,.1)">âš¡ Real-time</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <div onclick="switchTab(1)" style="flex:1;text-align:center;padding:8px;background:var(--bg3);border:1px solid var(--bdr);border-radius:10px;cursor:pointer;font-size:11px;font-weight:600;color:var(--t2)">ğŸ¤– Browse Agents</div>
        <div onclick="openModal('swap')" style="flex:1;text-align:center;padding:8px;background:var(--bg3);border:1px solid var(--bdr);border-radius:10px;cursor:pointer;font-size:11px;font-weight:600;color:var(--t2)">ğŸ”„ Buy AGNT</div>
      </div>
    </div>
    <div class="stats-grid anim-fadeup-1" style="margin-top:0">
      <div class="stat-card"><div class="stat-label">Agents</div><div class="stat-value" style="color:var(--g)">${AGENTS.length}</div><div class="stat-change up">Active</div></div>
      <div class="stat-card"><div class="stat-label">My Queries</div><div class="stat-value">${totalQueries}</div><div class="stat-change up">Total</div></div>
      <div class="stat-card"><div class="stat-label">Spent</div><div class="stat-value">${totalSpent.toFixed(2)}</div><div class="stat-change" style="color:var(--t3)">TON</div></div>
    </div>
    <div class="section-label anim-fadeup-2"><span>Platform Info</span></div>
    <div class="info-card anim-fadeup-2" style="margin-bottom:12px">
      <div class="info-row"><span class="info-label">Token</span><span class="info-value">AGNT</span></div>
      <div class="info-row"><span class="info-label">Supply</span><span class="info-value">100,000,000</span></div>
      <div class="info-row"><span class="info-label">Network</span><span class="info-value" style="color:var(--g)">TON Mainnet</span></div>
      <div class="info-row"><span class="info-label">AI Engine</span><span class="info-value" style="color:var(--p)">Claude Haiku</span></div>
      <div class="info-row"><span class="info-label">Status</span><span class="info-value" style="color:var(--g)" id="netStatus">â— Online</span></div>
    </div>
    <div class="section-label anim-fadeup-3"><span>AI Agents</span><span class="section-link" onclick="switchTab(1)">View All â†’</span></div>
    <div class="agent-scroll anim-fadeup-3">
      ${topAgents.map(a => `
        <div class="agent-card" onclick="openChat(${a.id})" style="--accent:${a.color}">
          <div class="agent-top">
            <div class="agent-avatar" style="background:${a.color}18">${a.icon}</div>
            <div><div class="agent-name">${a.name}</div><div class="agent-cat">${a.cat} Â· â­${a.rating}</div></div>
          </div>
          <div class="agent-stats">
            <div><div class="agent-stat-val">${a.queries}</div><div class="agent-stat-label">Queries</div></div>
            <div><div class="agent-stat-val" style="color:var(--g)">${a.price}</div><div class="agent-stat-label">TON/msg</div></div>
          </div>
        </div>
      `).join('')}
    </div>
    <div class="section-label anim-fadeup-4"><span>My Activity</span></div>
    ${transactions.length ? transactions.slice(0, 5).map(renderTxItem).join('') : '<div style="padding:20px 16px;text-align:center;font-size:12px;color:var(--t3)">No activity yet â€” tap an agent above to start chatting!</div>'}
  `;
  document.getElementById('homeContent').innerHTML = html;
}

function renderTxItem(tx) {
  const icons = {query:"ğŸ’¬", mint:"ğŸª™", deploy:"ğŸš€", send:"â†—ï¸", receive:"â†™ï¸"};
  const bgs = {query:"var(--pd)", mint:"var(--gd)", deploy:"var(--bd)", send:"var(--od)", receive:"var(--gd)"};
  return `<div class="agent-list-item" style="border-bottom:1px solid var(--bdr)">
    <div class="ali-icon" style="background:${bgs[tx.type]||'var(--gd)'};font-size:16px">${icons[tx.type]||'ğŸ’¬'}</div>
    <div class="ali-info"><div class="ali-name">${tx.title}</div><div class="ali-desc">${tx.subtitle}</div></div>
    <div class="ali-right"><div class="ali-price" style="color:${tx.amount>0?'var(--g)':'var(--r)'}">${tx.amount>0?'+':''}${tx.amount}</div><div class="ali-rating">${tx.time}</div></div>
  </div>`;
}

function filterAgents(val) { agentSearch = val.toLowerCase(); renderAgentList(); }

function renderAgentList() {
  // Tabs
  document.getElementById('agentTabs').innerHTML = ['All','Trading','DeFi','NFT','Social','Data'].map(c =>
    `<div class="pill ${agentFilter===c?'active':''}" onclick="agentFilter='${c}';renderAgentList()">${c}</div>`
  ).join('');
  // Filtered list
  const filtered = AGENTS.filter(a => (agentFilter==='All' || a.cat===agentFilter) && (!agentSearch || a.name.toLowerCase().includes(agentSearch) || a.desc.toLowerCase().includes(agentSearch)));
  document.getElementById('agentList').innerHTML = filtered.length ? filtered.map(a =>
    `<div class="agent-list-item" onclick="openChat(${a.id})">
      <div class="ali-icon" style="background:${a.color}15;font-size:18px">${a.icon}</div>
      <div class="ali-info"><div class="ali-name">${a.name}</div><div class="ali-desc">${a.desc}</div></div>
      <div class="ali-right"><div class="ali-price">${a.price} TON</div><div class="ali-rating">â­${a.rating}</div></div>
    </div>`
  ).join('') : '<div style="padding:40px;text-align:center;color:var(--t3);font-size:13px">No agents found</div>';
}

function renderRecentChats() {
  const ids = Object.keys(chatHistories).map(Number);
  const hasChats = ids.length > 0;
  try { document.getElementById('chatEmptyMsg').style.display = hasChats ? 'none' : 'block'; } catch(e) {}
  document.getElementById('recentChats').innerHTML = hasChats ? ids.map(id => {
    const a = AGENTS.find(x => x.id === id);
    if (!a) return '';
    const lastMsg = chatHistories[id]?.slice(-1)[0];
    const preview = lastMsg ? (lastMsg.text || '').replace(/<[^>]*>/g, '').slice(0, 40) : '';
    return `<div class="agent-list-item" onclick="openChat(${id})">
      <div class="ali-icon" style="background:${a.color}15;font-size:18px">${a.icon}</div>
      <div class="ali-info"><div class="ali-name">${a.name}</div><div class="ali-desc">${preview || chatHistories[id].length + ' messages'}</div></div>
      <div class="ali-right"><div class="ali-rating">${chatHistories[id].length} msg</div></div>
    </div>`;
  }).join('') : '';
}

function renderEarn() {
  const done = TASKS.filter(t => t.done).length;
  const earned = TASKS.filter(t => t.done).reduce((s, t) => s + t.reward, 0);
  document.getElementById('earnProgress').textContent = done + '/' + TASKS.length + ' completed';
  document.getElementById('earnTotal').textContent = earned + ' AGNT earned';
  const totalPossible = TASKS.reduce((s,t) => s + t.reward, 0);
  try {
    document.getElementById('earnTotalBig').textContent = earned.toLocaleString();
    document.getElementById('earnRemain').textContent = (totalPossible - earned).toLocaleString();
    document.getElementById('earnMsgs').textContent = totalMsgCount;
  } catch(e) {}
  document.getElementById('earnBar').style.width = (done / TASKS.length * 100) + '%';
  document.getElementById('earnList').innerHTML = TASKS.map((t, i) =>
    `<div class="earn-card ${t.done ? 'done' : ''}" onclick="${t.done ? '' : 'completeTask(' + i + ')'}">
      <div class="earn-icon" style="background:${t.done ? 'var(--bg3)' : 'var(--gd)'}">${t.done ? 'âœ…' : t.icon}</div>
      <div class="earn-info"><div class="earn-title">${t.title}</div><div class="earn-desc">${t.desc}</div></div>
      <div class="earn-reward">${t.done ? 'Done' : '+' + t.reward}</div>
    </div>`
  ).join('');
}

function completeTask(i) {
  if (TASKS[i].done) return;
  TASKS[i].done = true;
  toast('ğŸ‰ Task completed! +' + TASKS[i].reward + ' AGNT'); haptic('success');
  saveState();
  renderEarn();
}

function renderProfile() {
  document.getElementById('profileStats').innerHTML = `
    <div class="stat-card"><div class="stat-label">AGNT Balance</div><div class="stat-value" style="color:var(--g)">${Math.floor(balance).toLocaleString()}</div></div>
    <div class="stat-card"><div class="stat-label">Queries</div><div class="stat-value">${AGENTS.reduce((s,a)=>s+a.queries,0)}</div></div>
    <div class="stat-card"><div class="stat-label">Chats</div><div class="stat-value">${Object.keys(chatHistories).length}</div></div>
  `;
  document.getElementById('profileAgents').innerHTML = AGENTS.slice(0, 3).map(a =>
    `<div class="agent-list-item" onclick="openChat(${a.id})">
      <div class="ali-icon" style="background:${a.color}15;font-size:16px">${a.icon}</div>
      <div class="ali-info"><div class="ali-name">${a.name}</div><div class="ali-desc">${a.queries} queries</div></div>
      <div class="ali-right"><div class="ali-price" style="color:var(--g)">${a.price} TON</div><div class="ali-rating">Active âœ“</div></div>
    </div>`
  ).join('');
}

// â•â•â• CHAT SYSTEM â•â•â•
function openChat(id) {
  currentAgent = AGENTS.find(a => a.id === id);
  if (!currentAgent) return;
  document.getElementById('chatAgentName').textContent = currentAgent.name;
  document.getElementById('chatCost').textContent = currentAgent.price + ' TON';
  if (!chatHistories[id]) {
    chatHistories[id] = [
      { type: 'system', text: 'Connected to ' + currentAgent.name },
      { type: 'agent', text: currentAgent.icon + ' Hey! I\'m <b>' + currentAgent.name + '</b>. ' + currentAgent.desc + '.<br><br><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">' + getSuggestions(currentAgent.name).map(s => '<span onclick="document.getElementById(\'chatInput\').value=\''+s+'\';" style="font-size:11px;padding:5px 10px;background:rgba(0,255,200,.06);border:1px solid rgba(0,255,200,.1);border-radius:12px;cursor:pointer;color:var(--g)">' + s + '</span>').join('') + '</div>' }
    ];
  }
  renderMessages();
  document.getElementById('chatPanel').classList.add('open');
}

function closeChat() {
  document.getElementById('chatPanel').classList.remove('open');
  renderRecentChats();
}

function renderMessages() {
  if (!currentAgent) return;
  const el = document.getElementById('chatMessages');
  el.innerHTML = chatHistories[currentAgent.id].map(m =>
    `<div class="msg ${m.type === 'user' ? 'user' : m.type === 'agent' ? 'agent' : 'system'}">${m.text}</div>`
  ).join('');
  el.scrollTop = el.scrollHeight;
}

async function sendMessage() {
  if (!currentAgent) return;
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  if (!wallet) { toast('Connect wallet first', true); return; }

  input.value = '';
  const agentId = currentAgent.id;
  const agentName = currentAgent.name;
  const price = currentAgent.price;
  if (!chatHistories[agentId]) chatHistories[agentId] = [];
  chatHistories[agentId].push({ type: 'user', text: text });
  renderMessages();

  const el = document.getElementById('chatMessages');
  const typingEl = document.createElement('div');
  typingEl.className = 'msg agent';
  typingEl.id = 'typingDot';
  typingEl.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
  el.appendChild(typingEl);
  el.scrollTop = el.scrollHeight;

  toast('ğŸ’³ Confirm ' + price + ' TON...');
  let paid = false;
  try { paid = await sendTONPayment(price); } catch(e) { toast('Pay error', true); }
  
  if (!paid) {
    try { document.getElementById('typingDot').remove(); } catch(e){}
    chatHistories[agentId].pop();
    renderMessages();
    toast('Payment cancelled', true); haptic('error');
    return;
  }

  chatHistories[agentId].push({ type: 'system', text: 'âœ… Paid ' + price + ' TON Â· Processing...' });
  transactions.unshift({ type:'query', title:'Query: '+agentName, subtitle:text.slice(0,40), amount:-price, time:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) });
  renderMessages();
  // Re-add typing since renderMessages cleared it
  const el2 = document.getElementById('chatMessages');
  const typ2 = document.createElement('div');
  typ2.className = 'msg agent';
  typ2.id = 'typingDot2';
  typ2.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
  el2.appendChild(typ2);
  el2.scrollTop = el2.scrollHeight;

  if (!TASKS[2].done) TASKS[2].done = true;
  // Track real query count
  const ag = AGENTS.find(a => a.id === agentId);
  if (ag) ag.queries++;
  totalMsgCount++;

  // querying AI
  let response = '';
  try {
    response = await callAI(agentName, text);
  } catch(e) {
    response = 'âš ï¸ Error: ' + e.message;
    toast('AI error: ' + e.message, true);
  }

  try { document.getElementById('typingDot2').remove(); } catch(e){}
  
  if (!response) response = getFallback(agentName);
  const formatted = response.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
  chatHistories[agentId].push({ type: 'agent', text: formatted });
  renderMessages();
  saveState();
  // done
}

// â•â•â• MODAL SYSTEM â•â•â•
function openModal(type) {
  const body = document.getElementById('modalBody');
  
  switch (type) {
    case 'send':
      if (!wallet) { toast('Connect wallet first', true); return; }
      body.innerHTML = `<h3>ğŸ“¤ Send AGNT</h3><p>Transfer tokens to any TON address</p>
        <div class="form-group"><label class="form-label">Recipient</label><input class="form-input" id="sendTo" placeholder="EQA... or UQA..."></div>
        <div class="form-group"><label class="form-label">Amount</label><input class="form-input" id="sendAmt" type="number" placeholder="0.00">
          <div style="font-size:10px;color:var(--t3);margin-top:4px">Available: <span style="color:var(--g)">${Math.floor(balance).toLocaleString()} AGNT</span></div>
        </div>
        <button class="btn btn-primary" onclick="doSend()">Send via TonConnect</button>
        <div class="btn-hint">Sends Jetton transfer via wallet</div>
        <span class="modal-close" onclick="closeModal()">Cancel</span>`;
      break;
    case 'receive':
      body.innerHTML = `<h3>ğŸ“¥ Receive AGNT</h3><p>Share your address to receive tokens</p>
        <div class="info-card" style="margin:0 0 16px"><div class="info-row" style="border:none;word-break:break-all"><span class="info-value" style="font-size:10px">${userAddress || CONTRACT}</span></div></div>
        <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${userAddress || CONTRACT}');toast('ğŸ“‹ Address copied!')">Copy Address</button>
        <span class="modal-close" onclick="closeModal()">Close</span>`;
      break;
    case 'swap':
      body.innerHTML = `<h3>ğŸ”„ Swap for AGNT</h3><p>Trade on STON.fi or DeDust</p>
        <div class="info-card" style="margin:0 0 16px"><div class="info-row"><span class="info-label">Buy AGNT on DEX</span><span class="info-value">${CONTRACT.slice(0,12)}...</span></div></div>
        <button class="btn btn-primary" onclick="window.open('https://app.ston.fi/swap?chartVisible=false&ft=TON&tt=${CONTRACT}')">Open STON.fi</button>
        <div style="margin-top:8px"><button class="btn btn-secondary" onclick="window.open('https://dedust.io/swap/TON/${CONTRACT}')">Open DeDust</button></div>
        <span class="modal-close" onclick="closeModal()">Close</span>`;
      break;
    case 'history':
      body.innerHTML = `<h3>ğŸ“‹ Transactions</h3><p>View on explorer</p>
        <button class="btn btn-primary" onclick="window.open('https://tonviewer.com/${userAddress || CONTRACT}')">View on TonViewer</button>
        <div style="margin-top:8px"><button class="btn btn-secondary" onclick="window.open('https://tonscan.org/address/${userAddress || CONTRACT}')">View on TonScan</button></div>
        ${transactions.length ? '<div style="margin-top:16px">' + transactions.map(renderTxItem).join('') + '</div>' : ''}
        <span class="modal-close" onclick="closeModal()">Close</span>`;
      break;
    case 'deploy':
      body.innerHTML = `<h3>ğŸ¤– Deploy Agent</h3><p>Create an AI agent on AGNT platform</p>
        <div class="form-group"><label class="form-label">Agent Name</label><input class="form-input" id="deployName" placeholder="e.g. DeFi Analyzer"></div>
        <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="deployCat"><option>Trading</option><option>DeFi</option><option>NFT</option><option>Social</option><option>Data</option></select></div>
        <div class="form-group"><label class="form-label">Price Per Query (TON)</label><input class="form-input" id="deployPrice" type="number" step="0.01" placeholder="0.05"></div>
        <button class="btn btn-primary" onclick="doDeploy()">ğŸš€ Deploy Agent</button>
        <div class="btn-hint">Fee: <span>0.5 TON</span></div>
        <span class="modal-close" onclick="closeModal()">Cancel</span>`;
      break;
    case 'wallet':
      body.innerHTML = `<h3>ğŸ‘› Wallet</h3><p>Connected via TonConnect</p>
        <div class="info-card" style="margin:0 0 16px">
          <div class="info-row"><span class="info-label">Address</span><span class="info-value">${userAddress.slice(0,8)}...${userAddress.slice(-6)}</span></div>
          <div class="info-row"><span class="info-label">AGNT Balance</span><span class="info-value" style="color:var(--g)">${Math.floor(balance).toLocaleString()}</span></div>
          <div class="info-row"><span class="info-label">Network</span><span class="info-value">TON Mainnet</span></div>
        </div>
        <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${userAddress}');toast('ğŸ“‹ Copied!')">Copy Address</button>
        <div style="margin-top:8px"><button class="btn btn-secondary" onclick="window.open('https://tonviewer.com/${userAddress}')">View on Explorer</button></div>
        <div style="margin-top:8px"><button class="btn btn-danger" onclick="if(tonUI)tonUI.disconnect();closeModal()">Disconnect</button></div>
        <span class="modal-close" onclick="closeModal()">Close</span>`;
      break;
    case 'editProfile':
      body.innerHTML = `<h3>âœï¸ Edit Profile</h3>
        <div class="form-group"><label class="form-label">Display Name</label><input class="form-input" id="editName" placeholder="Your name"></div>
        <button class="btn btn-primary" onclick="document.getElementById('profileName').textContent=document.getElementById('editName').value||'â€”';toast('âœ… Updated');closeModal()">Save</button>
        <span class="modal-close" onclick="closeModal()">Cancel</span>`;
      break;
    case 'settings':
      body.innerHTML = `<h3>âš™ï¸ Settings</h3>
        <div class="agent-list-item" onclick="toast('ğŸ”” Notifications on')"><div class="ali-icon" style="background:var(--gd)">ğŸ””</div><div class="ali-info"><div class="ali-name">Notifications</div></div><div class="ali-right" style="color:var(--g);font-size:12px;font-weight:600">On</div></div>
        <div class="agent-list-item" onclick="window.open('https://tonviewer.com/${CONTRACT}')"><div class="ali-icon" style="background:var(--bd)">ğŸ“œ</div><div class="ali-info"><div class="ali-name">View Contract</div><div class="ali-desc">${CONTRACT.slice(0,20)}...</div></div></div>
        <div class="agent-list-item" onclick="toast('v3.5.0')"><div class="ali-icon" style="background:var(--pd)">â„¹ï¸</div><div class="ali-info"><div class="ali-name">App Version</div><div class="ali-desc">AGNT MiniApp v3.5.0</div></div></div>
        <span class="modal-close" onclick="closeModal()">Close</span>`;
      break;
    case 'agentDetail':
      if (!currentAgent) break;
      const a = currentAgent;
      body.innerHTML = `<div style="text-align:center;padding:10px 0">
        <div style="width:56px;height:56px;border-radius:16px;background:${a.color}18;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto">${a.icon}</div>
        <h3 style="margin-top:10px">${a.name}</h3>
        <div style="font-size:12px;color:var(--t3);margin-top:2px">${a.cat} Agent Â· â­ ${a.rating}</div>
        <div style="font-size:12px;color:var(--t2);margin-top:8px;line-height:1.5">${a.desc}</div>
      </div>
      <div class="stats-grid" style="margin-top:12px;padding:0">
        <div class="stat-card"><div class="stat-label">Price</div><div class="stat-value" style="color:var(--g)">${a.price}</div><div class="stat-change" style="color:var(--t3)">TON/msg</div></div>
        <div class="stat-card"><div class="stat-label">Queries</div><div class="stat-value">${a.queries}</div><div class="stat-change up">Total</div></div>
        <div class="stat-card"><div class="stat-label">Rating</div><div class="stat-value" style="color:var(--o)">â­ ${a.rating}</div></div>
      </div>
      <button class="btn btn-primary" style="margin-top:16px" onclick="closeModal();openChat(${a.id})">ğŸ’¬ Start Chat â€” ${a.price} TON/msg</button>
      <span class="modal-close" onclick="closeModal()">Close</span>`;
      break;
    case 'referral':
      body.innerHTML = `<h3>ğŸ“£ Invite Friends</h3><p>Share AGNT and earn rewards when friends join</p>
        <div class="info-card" style="margin:0 0 16px">
          <div class="info-row" style="border:none;word-break:break-all"><span class="info-value" style="font-size:10px;color:var(--g)">${getReferralLink()}</span></div>
        </div>
        <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${getReferralLink().replace(/'/g, "\'")}');toast('ğŸ“‹ Referral link copied!');haptic('success')">Copy Referral Link</button>
        <div style="margin-top:8px"><button class="btn btn-secondary" onclick="if(window.Telegram&&Telegram.WebApp)Telegram.WebApp.openTelegramLink('https://t.me/share/url?url='+encodeURIComponent('${getReferralLink().replace(/'/g, "\'")}')+'&text='+encodeURIComponent('Try AGNT - AI Agents on TON! ğŸ¤–'));else navigator.share?.({text:'Try AGNT - AI Agents on TON!',url:'${getReferralLink().replace(/'/g, "\'")}'})">Share via Telegram</button></div>
        <span class="modal-close" onclick="closeModal()">Close</span>`;
      break;
    case 'notifs':
      document.getElementById('nDot').style.display = 'none';
      body.innerHTML = `<h3>ğŸ”” Notifications</h3>` +
        [['ğŸ¤– Platform','AGNT MiniApp v3.5 is live!','now'],['ğŸ“ˆ Token','AGNT deployed on TON Mainnet','new'],['ğŸ§  AI Engine','Powered by Claude Haiku','new'],['ğŸ”— Network','Running on TON Blockchain','live']].map(n =>
          `<div class="agent-list-item"><div class="ali-icon" style="background:var(--gd)">${n[0].split(' ')[0]}</div><div class="ali-info"><div class="ali-name">${n[0]}</div><div class="ali-desc">${n[1]}</div></div><div class="ali-right"><div class="ali-rating">${n[2]}</div></div></div>`
        ).join('') +
        `<span class="modal-close" onclick="closeModal()">Close</span>`;
      break;
  }
  document.getElementById('overlay').classList.add('open');
}

function closeModal() { document.getElementById('overlay').classList.remove('open'); }

function doSend() {
  const to = document.getElementById('sendTo')?.value?.trim();
  const amt = parseFloat(document.getElementById('sendAmt')?.value);
  if (!to) { toast('Enter recipient address', true); return; }
  if (!amt || amt <= 0) { toast('Enter valid amount', true); return; }
  toast('ğŸ“¤ Opening wallet to confirm...');
  closeModal();
}

async function doDeploy() {
  if (!wallet) { toast('Connect wallet first', true); return; }
  const name = document.getElementById('deployName')?.value?.trim() || 'My Agent';
  const cat = document.getElementById('deployCat')?.value || 'Trading';
  const price = parseFloat(document.getElementById('deployPrice')?.value) || 0.05;
  toast('ğŸ’³ Confirm 0.5 TON deploy fee...');
  closeModal();
  const paid = await sendTONPayment(0.5);
  if (!paid) { toast('Deploy cancelled', true); return; }
  const icons = { Trading:"ğŸ“ˆ", DeFi:"ğŸ§™", NFT:"ğŸ¨", Social:"ğŸ“¡", Data:"ğŸ“Š" };
  AGENTS.push({
    id: AGENTS.length + 1, name, cat, icon: icons[cat] || "ğŸ¤–", color: "#00ffc8",
    price, queries: 0, rating: 5.0, desc: "Custom deployed agent", isNew: true
  });
  transactions.unshift({ type:'deploy', title:'Deploy: '+name, subtitle:cat+' agent', amount:-0.5, time:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) });
  if (!TASKS[3].done) { TASKS[3].done = true; }
  toast('ğŸš€ ' + name + ' deployed!');
  haptic('success');
  renderAll();
}

// â•â•â• TOAST â•â•â•
function toast(msg, isError) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 2800);
}

// â•â•â• HAPTIC â•â•â•
function haptic(type) {
  try {
    if (window.Telegram && Telegram.WebApp && Telegram.WebApp.HapticFeedback) {
      if (type === 'light') Telegram.WebApp.HapticFeedback.impactOccurred('light');
      else if (type === 'medium') Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      else if (type === 'success') Telegram.WebApp.HapticFeedback.notificationOccurred('success');
      else if (type === 'error') Telegram.WebApp.HapticFeedback.notificationOccurred('error');
    }
  } catch(e) {}
}

// â•â•â• PERSISTENCE â•â•â•
function saveState() {
  try {
    const state = {
      chatHistories,
      transactions: transactions.slice(0, 50),
      totalMsgCount,
      agents: AGENTS.map(a => ({id:a.id, queries:a.queries})),
      tasks: TASKS.map(t => t.done)
    };
    localStorage.setItem('agnt_state', JSON.stringify(state));
  } catch(e) {}
}

function loadState() {
  try {
    const raw = localStorage.getItem('agnt_state');
    if (!raw) return;
    const state = JSON.parse(raw);
    if (state.chatHistories) chatHistories = state.chatHistories;
    if (state.transactions) transactions = state.transactions;
    if (state.totalMsgCount) totalMsgCount = state.totalMsgCount;
    if (state.agents) state.agents.forEach(sa => {
      const ag = AGENTS.find(a => a.id === sa.id);
      if (ag) ag.queries = sa.queries;
    });
    if (state.tasks) state.tasks.forEach((done, i) => {
      if (TASKS[i]) TASKS[i].done = done;
    });
  } catch(e) {}
}

// â•â•â• INIT â•â•â•
loadState();
renderAll();
initTelegram();
initTonConnect();

// Show connect wallet prompt if not connected after 2s
setTimeout(() => {
  if (!wallet) {
    toast('ğŸ‘‹ Connect your wallet to get started!');
  }
}, 2000);
</script>
</body>
</html>
